# شرح سير عمل أتمتة استخراج وتوليد خرائط الأدوات (Gadgets)

## مقدمة

بناءً على رغبتك في تطوير استغلال `psfree-lapse` بشكل احترافي ومبتكر، وبهدف تسهيل عملية تحديث ودعم إصدارات جديدة من البرامج الثابتة، قمنا بالتركيز على أتمتة واحدة من أكثر المهام استهلاكًا للوقت: إيجاد وتحديث الأدوات (gadgets) المستخدمة في سلاسل ROP/JOP.

يوضح هذا المستند سير العمل الذي قمنا بتطويره، والذي يسمح باستخراج الأدوات من أي ملف ثنائي (مثل مكتبات النظام أو البرامج التنفيذية) وتحويلها تلقائيًا إلى كود JavaScript جاهز للاستخدام في مشروع `psfree-lapse` أو أي مشروع مشابه.

## خطوات سير العمل المؤتمت:

1.  **تجهيز الملف الثنائي (Binary File):**
    *   في هذا المثال، قمنا بإنشاء ملف كود بسيط بلغة C اسمه `test_rop.c`. هذا الملف يحتوي على بعض الدوال التي قد تنتج أدوات ROP بسيطة عند ترجمتها.
    *   تمت ترجمة هذا الملف باستخدام مترجم GCC لإنتاج ملف ثنائي قابل للتنفيذ بصيغة ELF اسمه `test_rop_binary`. الأمر المستخدم للترجمة كان:
        `gcc -o /home/ubuntu/test_rop_binary /home/ubuntu/test_rop.c -no-pie -fno-plt`
        *   الخيارات `-no-pie` و `-fno-plt` تساعد في الحصول على عناوين ثابتة للأدوات في الملف الثنائي الصغير الخاص بنا، مما يسهل عملية الاختبار.

2.  **استخراج الأدوات باستخدام `ROPgadget`:**
    *   قمنا بتثبيت أداة `ROPgadget`، وهي أداة مفتوحة المصدر متخصصة في البحث عن أدوات ROP/JOP داخل الملفات الثنائية.
    *   تم تشغيل `ROPgadget` على الملف الثنائي `test_rop_binary` الذي أنشأناه. الأمر المستخدم كان:
        `ROPgadget --binary /home/ubuntu/test_rop_binary --ropchain`
    *   مخرجات هذه الأداة (والتي تحتوي على قائمة بالأدوات المكتشفة وعناوينها) تم حفظها في ملف نصي اسمه `rop_gadget_output.txt`.

3.  **معالجة مخرجات `ROPgadget` وتوليد كود JavaScript:**
    *   قمنا بتطوير سكربت بايثون مخصص اسمه `ropgadget_to_js_parser.py`.
    *   هذا السكربت يقوم بالآتي:
        *   يقرأ ملف `rop_gadget_output.txt` (مخرجات `ROPgadget`).
        *   يحلل (parses) النص لاستخلاص عنوان كل أداة وسلسلة التعليمات الخاصة بها.
        *   يقوم بتنسيق هذه المعلومات ليحولها إلى كود JavaScript صالح يمثل كائن `Map`.
        *   هذا الكائن `Map` (الذي سميناه `auto_generated_gadget_offsets` في المثال) يحتوي على سلاسل التعليمات كمفاتيح (keys) وعناوينها كقيم (values)، وهو نفس التنسيق المستخدم في ملفات مشروع `psfree-lapse` (مثل `800.mjs`).
    *   الخرج النهائي من هذا السكربت هو ملف JavaScript (في مثالنا، حفظناه باسم `auto_generated_rop_gadgets.js`) يحتوي على تعريف الـ `Map` المولد تلقائيًا.

## كيفية الاستفادة من هذا السير العمل في مشروع حقيقي:

1.  **الحصول على الملفات الثنائية المستهدفة:** لتطبيق هذا على مشروع `psfree-lapse` بشكل فعلي، ستحتاج إلى الملفات الثنائية الفعلية من نظام PS4 أو PS5 التي تحتوي على الأدوات التي تبحث عنها (مثل ملفات WebKit، libkernel، libc، إلخ). هذه الملفات عادة ما يتم تفريغها (dumped) من الجهاز المستهدف.
2.  **تشغيل `ROPgadget`:** قم بتشغيل `ROPgadget` على هذه الملفات الثنائية الفعلية.
3.  **استخدام سكربت `ropgadget_to_js_parser.py`:** قم بتمرير مخرجات `ROPgadget` إلى سكربت البايثون الخاص بنا.
4.  **دمج الكود المولد:** الكود JavaScript الذي يولده السكربت يمكن نسخه ولصقه مباشرة في ملفات `.mjs` المناسبة ضمن مشروع `psfree-lapse` (مثلاً، لتحديث `webkit_gadget_offsets`، `libc_gadget_offsets`، إلخ).

## الميزات والفوائد:

*   **الأتمتة:** يقلل بشكل كبير من الجهد اليدوي المطلوب لإيجاد وتوثيق الأدوات.
*   **السرعة:** يسرع عملية دعم إصدارات جديدة من البرامج الثابتة، حيث يمكن إعادة توليد خرائط الأدوات بسرعة لأي ملف ثنائي جديد.
*   **الدقة:** يقلل من احتمالية الأخطاء البشرية عند نسخ ولصق العناوين أو سلاسل التعليمات.
*   **المرونة:** يمكن تكييف سكربت البايثون بسهولة للتعامل مع تنسيقات مخرجات مختلفة قليلاً أو لإضافة ميزات إضافية (مثل تصفية الأدوات أو تصنيفها).

هذا السير العمل يمثل خطوة مهمة نحو تطوير أكثر كفاءة واحترافية لاستغلالات مثل `psfree-lapse`، ويفتح الباب لمزيد من الابتكار في هذا المجال.

